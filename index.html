<!DOCTYPE html><html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>لعبة الثعبان — نسخة صفحة واحدة</title>
  <style>
    :root {
      --bg: #0f1226;
      --panel: #181c39;
      --panel-2: #0b0e22;
      --text: #e7ecff;
      --muted: #94a3b8;
      --accent: #5eead4;
      --danger: #ff6b6b;
      --food: #ffd166;
      --snake: #7dd3fc;
      --grid: #233055;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Kufi Arabic", "Noto Sans Arabic", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1000px 600px at 70% -10%, #1d2150, var(--bg)) fixed;
      display: grid;
      place-items: center;
      padding: 16px;
    }
    .card {
      width: min(92vw, 900px);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      border: 1px solid #273056;
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.45);
      padding: 14px;
    }
    .top {
      display: flex; gap: 12px; align-items: center; justify-content: space-between;
      padding: 8px 6px 12px;
      border-bottom: 1px dashed #2a3966;
    }
    .title {
      font-weight: 700; letter-spacing: .3px;
    }
    .scorebar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    .chip {
      background: #0e1330; border: 1px solid #20305e; color: var(--text);
      padding: 6px 10px; border-radius: 12px; font-size: 14px; min-width: 90px; text-align: center;
    }
    .btns { display: flex; gap: 8px; flex-wrap: wrap; }
    button {
      appearance: none; cursor: pointer; border: 1px solid #1f2b54; color: var(--text);
      background: #0f1738; padding: 8px 12px; border-radius: 12px; font-weight: 700; font-size: 14px;
      transition: transform .06s ease, box-shadow .2s ease, background .2s ease; min-width: 84px;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .accent { background: #102b3f; border-color: #234c70; }
    .danger { background: #2a0f19; border-color: #6c1e33; }
    canvas { width: 100%; height: auto; border-radius: 14px; display: block; background: #0b1125; }
    .foot { color: var(--muted); font-size: 12px; text-align: center; margin-top: 10px; }
    .row { display: grid; grid-template-columns: 1fr; gap: 12px; }.help {
  position: fixed; inset: 0; display: none; place-items: center; backdrop-filter: blur(4px);
  background: rgba(5,8,20,0.6); z-index: 20; padding: 16px;
}
.help .panel {
  width: min(92vw, 760px); background: #0e1230; border: 1px solid #22315f; border-radius: 16px; padding: 18px;
}
.help h2 { margin: 0 0 8px; }
.list { color: #c7d2fe; line-height: 1.7; }
code { background: #0a0f26; padding: 1px 6px; border: 1px solid #1b2856; border-radius: 8px; }

.touch-hint { display: none; }
@media (max-width: 640px) { .touch-hint { display: inline; } }

  </style>
</head>
<body>
  <div class="card" role="region" aria-label="لعبة الثعبان">
    <div class="top">
      <div class="title">🐍 لعبة الثعبان — صفحة واحدة (HTML/CSS/JS)</div>
      <div class="scorebar">
        <div class="chip">النقاط: <span id="score">0</span></div>
        <div class="chip">أفضل نتيجة: <span id="best">0</span></div>
        <div class="chip">السرعة: <span id="speed">1×</span></div>
      </div>
      <div class="btns" role="toolbar" aria-label="أزرار التحكم">
        <button id="startBtn" class="accent" title="ابدأ / استئناف (مسافة)">ابدأ</button>
        <button id="pauseBtn" title="إيقاف مؤقت (مسافة)">إيقاف</button>
        <button id="resetBtn" class="danger" title="إعادة تشغيل (R)">إعادة</button>
        <button id="helpBtn" title="إرشادات (؟)">؟</button>
      </div>
    </div><div class="row">
  <canvas id="game" aria-label="مساحة اللعب" tabindex="0"></canvas>
  <div class="foot">التحكم: الأسهم / WASD / السحب <span class="touch-hint">(إلمس وحرّك)</span> — مساحة للإيقاف/الاستئناف — R لإعادة التشغيل.</div>
</div>

  </div>  <div id="help" class="help" aria-hidden="true">
    <div class="panel">
      <h2>❓ كيف تُلعب؟</h2>
      <ul class="list">
        <li>حرّك الثعبان لالتقاط الطعام الذهبي دون أن تصطدم بالجدار أو بنفسك.</li>
        <li>المفاتيح: الأسهم أو <code>W/A/S/D</code>. على الجوال: اسحب بإصبعك لاتجاه الحركة.</li>
        <li>مسافة = إيقاف/استئناف. مفتاح <code>R</code> = إعادة. أفضل نتيجة تُحفَظ تلقائياً في المتصفّح.</li>
      </ul>
      <div class="btns" style="justify-content:end; margin-top:12px">
        <button id="closeHelp" class="accent">مفهوم</button>
      </div>
    </div>
  </div>  <script>
  (() => {
    // ====== إعدادات عامة ======
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best');
    const speedEl = document.getElementById('speed');
    const help = document.getElementById('help');

    const GRID = 21;               // عدد الخلايا طولاً وعرضاً
    const BORDER = 10;             // هامش داخلي للرسم
    const BASE_SPEED_MS = 140;     // بداية السرعة (أصغر = أسرع)
    const MIN_SPEED_MS = 60;       // الحد الأدنى للسرعة
    const SPEED_STEP = 4;          // مقدار التسريع بعد أكل الطعام

    let cellSize = 20;             // سيُحسب تلقائياً
    let pixelRatio = Math.max(1, Math.floor(window.devicePixelRatio || 1));

    let loopId = null;             // معرّف المؤقت الرئيسي
    let tickMs = BASE_SPEED_MS;    // السرعة الحالية

    const DIRS = {
      ArrowUp: {x:0, y:-1}, ArrowDown: {x:0, y:1}, ArrowLeft: {x:-1,y:0}, ArrowRight: {x:1,y:0},
      KeyW: {x:0, y:-1}, KeyS: {x:0, y:1}, KeyA: {x:-1, y:0}, KeyD: {x:1, y:0}
    };

    // ====== حالة اللعبة ======
    let snake, dir, nextDir, food, score, best, playing, gameOver;

    function init() {
      score = 0; gameOver = false; playing = false; tickMs = BASE_SPEED_MS; nextDir = {x:1,y:0};
      const mid = Math.floor(GRID/2);
      snake = [ {x:mid-1,y:mid}, {x:mid,y:mid}, {x:mid+1,y:mid} ];
      dir = {x:1,y:0};
      food = spawnFood();
      best = Number(localStorage.getItem('snakeBest')||0);
      bestEl.textContent = best;
      scoreEl.textContent = score;
      updateSpeedLabel();
      fitCanvas();
      draw();
    }

    function updateSpeedLabel(){
      // اعرض السرعة كنسبة تقريبية
      const factor = (BASE_SPEED_MS / tickMs).toFixed(1);
      speedEl.textContent = factor + '×';
    }

    function fitCanvas(){
      // جعل اللوحة مناسبة لحجم البطاقة
      const maxW = document.querySelector('.card').clientWidth - 28; // padding
      const maxH = Math.min(window.innerHeight - 220, 620);
      const size = Math.max(260, Math.min(maxW, maxH));
      cellSize = Math.floor((size - BORDER*2) / GRID);
      const drawSize = cellSize * GRID + BORDER*2;
      canvas.style.width = drawSize + 'px';
      canvas.style.height = drawSize + 'px';
      canvas.width = drawSize * pixelRatio;
      canvas.height = drawSize * pixelRatio;
      ctx.setTransform(pixelRatio,0,0,pixelRatio,0,0);
    }

    // ====== أدوات ======
    function spawnFood(){
      while(true){
        const p = { x: Math.floor(Math.random()*GRID), y: Math.floor(Math.random()*GRID) };
        if(!snake.some(s=>s.x===p.x && s.y===p.y)) return p;
      }
    }
    function equal(a,b){ return a.x===b.x && a.y===b.y; }

    function start(){ if(!playing && !gameOver){ playing = true; runLoop(); } }
    function pause(){ playing = false; if(loopId) clearInterval(loopId); loopId = null; draw(); }
    function reset(){ if(loopId) clearInterval(loopId); loopId = null; init(); }

    function runLoop(){ if(loopId) clearInterval(loopId); loopId = setInterval(tick, tickMs); }

    function setDirection(newDir){
      // منع الانعكاس المباشر
      if((newDir.x + dir.x) === 0 && (newDir.y + dir.y) === 0) return;
      nextDir = newDir;
    }

    function tick(){
      if(!playing) return;
      dir = nextDir;
      // رأس جديد
      const head = { x: snake[snake.length-1].x + dir.x, y: snake[snake.length-1].y + dir.y };
      // تصادم مع الجدار؟
      if(head.x < 0 || head.x >= GRID || head.y < 0 || head.y >= GRID) { end(); return; }
      // تصادم مع النفس؟
      if(snake.some(s=> s.x===head.x && s.y===head.y)) { end(); return; }

      snake.push(head);
      if(equal(head, food)){
        score++;
        scoreEl.textContent = score;
        food = spawnFood();
        // أسرع قليلاً
        tickMs = Math.max(MIN_SPEED_MS, tickMs - SPEED_STEP);
        updateSpeedLabel();
        runLoop();
        blip();
      } else {
        snake.shift();
      }
      draw();
    }

    function end(){
      playing = false; gameOver = true; if(loopId) clearInterval(loopId); loopId=null;
      if(score > best){ best = score; localStorage.setItem('snakeBest', String(best)); bestEl.textContent = best; }
      draw(true);
    }

    // ====== رسم ======
    function draw(showGameOver=false){
      const W = canvas.width / pixelRatio; const H = canvas.height / pixelRatio;
      // خلفية
      roundRect(0,0,W,H,14, '#070b1b');
      // شبكة خفيفة
      const offset = BORDER; const s = cellSize;
      ctx.save();
      ctx.translate(offset, offset);
      ctx.fillStyle = '#0c1430';
      roundRect(-6,-6,GRID*s+12,GRID*s+12,12,'#0c1430');
      ctx.strokeStyle = 'rgba(64,92,160,.18)';
      ctx.lineWidth = 1;
      for(let i=1;i<GRID;i++){
        const p = Math.floor(i*s)+.5;
        ctx.beginPath(); ctx.moveTo(p,0); ctx.lineTo(p,GRID*s); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,p); ctx.lineTo(GRID*s,p); ctx.stroke();
      }
      // طعام
      drawCell(food.x, food.y, s, '#ffd166', true);
      // ثعبان
      for(let i=0;i<snake.length;i++){
        const c = snake[i];
        const isHead = i === snake.length-1;
        drawCell(c.x, c.y, s, isHead? '#7dd3fc' : '#51b5f3', false, isHead);
      }
      ctx.restore();

      if(showGameOver){
        overlay("انتهت اللعبة", "اضغط R للإعادة أو ابدأ مجدداً.");
      } else if(!playing){
        overlay("جاهز؟", "اضغط ابدأ أو المسافة للانطلاق.");
      }
    }

    function roundRect(x,y,w,h,r, fill){
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+w,y,x+w,y+h,r);
      ctx.arcTo(x+w,y+h,x,y+h,r);
      ctx.arcTo(x,y+h,x,y,r);
      ctx.arcTo(x,y,x+w,y,r);
      if(fill){ ctx.fillStyle = fill; ctx.fill(); }
    }

    function drawCell(cx, cy, s, color, isFood=false, isHead=false){
      const x = cx*s, y = cy*s;
      const r = Math.max(4, Math.floor(s*0.25));
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x+r,y);
      ctx.arcTo(x+s,y,x+s,y+s,r);
      ctx.arcTo(x+s,y+s,x,y+s,r);
      ctx.arcTo(x,y+s,x,y,r);
      ctx.arcTo(x,y,x+s,y,r);
      ctx.fill();
      if(isFood){
        // لمعة بسيطة
        ctx.fillStyle = 'rgba(255,255,255,.35)';
        ctx.beginPath(); ctx.ellipse(x+s*0.35,y+s*0.35,s*0.12,s*0.08,Math.PI/8,0,Math.PI*2); ctx.fill();
      }
      if(isHead){
        // عينان
        ctx.fillStyle = '#0b132b';
        const e = Math.max(2, Math.floor(s*0.08));
        const ox = dir.x===0 ? (s*0.25) : (dir.x>0? s*0.55 : s*0.25);
        const oy = dir.y===0 ? (s*0.3) : (dir.y>0? s*0.55 : s*0.25);
        ctx.beginPath(); ctx.arc(x+ox, y+oy, e, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+s-ox, y+oy, e, 0, Math.PI*2); ctx.fill();
      }
    }

    function overlay(title, subtitle){
      const W = canvas.width/pixelRatio, H = canvas.height/pixelRatio, pad = 18;
      ctx.save();
      ctx.fillStyle = 'rgba(5,8,20,.6)';
      roundRect(16,16,W-32,H-32,16,'rgba(5,8,20,.6)');
      ctx.fillStyle = '#e7ecff';
      ctx.font = '700 22px ui-sans-serif, system-ui';
      ctx.textAlign = 'center';
      ctx.fillText(title, W/2, H/2 - 8);
      ctx.fillStyle = '#b6c2ff';
      ctx.font = '14px ui-sans-serif, system-ui';
      ctx.fillText(subtitle, W/2, H/2 + 16);
      ctx.restore();
    }

    // ====== صوت بسيط عند الأكل ======
    const audioCtx = typeof AudioContext !== 'undefined' ? new AudioContext() : null;
    function blip(){
      if(!audioCtx) return;
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.value = 740; g.gain.value = 0.05;
      o.connect(g).connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + 0.08);
    }

    // ====== إدخال المستخدم ======
    document.addEventListener('keydown', e => {
      if(e.code in DIRS){ e.preventDefault(); setDirection(DIRS[e.code]); return; }
      if(e.code === 'Space'){ e.preventDefault(); playing ? pause() : start(); }
      if(e.code === 'KeyR'){ e.preventDefault(); reset(); }
      if(e.code === 'Slash' || e.key === '?'){ toggleHelp(true); }
    });

    // لمس (سحب) للجوال
    let touchStart = null;
    canvas.addEventListener('touchstart', e => { if(e.touches[0]) touchStart = {x:e.touches[0].clientX, y:e.touches[0].clientY}; }, {passive:true});
    canvas.addEventListener('touchend', e => {
      if(!touchStart) return; const t = e.changedTouches[0];
      const dx = t.clientX - touchStart.x, dy = t.clientY - touchStart.y;
      const ax = Math.abs(dx), ay = Math.abs(dy);
      if(Math.max(ax,ay) < 18) return; // تجاهل اللمسات القصيرة
      if(ax > ay) setDirection({x: dx>0? 1:-1, y:0}); else setDirection({x:0, y: dy>0? 1:-1});
      touchStart = null;
    }, {passive:true});

    // أزرار
    document.getElementById('startBtn').onclick = () => (playing ? null : start());
    document.getElementById('pauseBtn').onclick = () => (playing ? pause() : null);
    document.getElementById('resetBtn').onclick = () => reset();
    document.getElementById('helpBtn').onclick = () => toggleHelp(true);
    document.getElementById('closeHelp').onclick = () => toggleHelp(false);

    function toggleHelp(show){ help.style.display = show? 'grid' : 'none'; help.setAttribute('aria-hidden', show? 'false':'true'); }

    // ====== بدء التشغيل ======
    window.addEventListener('resize', () => { fitCanvas(); draw(gameOver && !playing); });
    canvas.addEventListener('click', () => { if(!playing && !gameOver) start(); });
    init();
  })();
  </script></body>
</html>
